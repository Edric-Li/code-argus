/**
 * 分类挑战策略
 *
 * 定义各类别问题在验证挑战阶段的专项提示词
 * 用于第2-4轮挑战验证，使验证更有针对性
 */

import type { IssueCategory } from '../types.js';

/**
 * 分类专项挑战策略配置
 *
 * 每个类别包含：
 * - round2: 分类专项确认提示
 * - round3: 分类专项证据请求
 * - round4Confirmed: 魔鬼代言人（当判定为确认时）
 * - round4Rejected: 魔鬼代言人（当判定为拒绝时）
 */
export interface CategoryChallengeStrategy {
  /** 第2轮：分类专项确认 */
  round2: string;
  /** 第3轮：分类专项证据请求 */
  round3: string;
  /** 第4轮（确认时）：考虑问题可能不存在的反面论点 */
  round4Confirmed: string;
  /** 第4轮（拒绝时）：考虑问题可能确实存在的反面论点 */
  round4Rejected: string;
}

/**
 * 各类别的挑战策略定义
 *
 * 用于验证器的多轮挑战验证，每个类别有针对性的问题：
 * - security: 关注攻击向量、上游防护、框架保护
 * - logic: 关注边界条件、测试覆盖、类型系统保证
 * - performance: 关注实际成本、调用频率、缓存机制
 * - style: 关注项目模式、ESLint/Prettier规则
 * - maintainability: 关注复杂度匹配、项目架构一致性
 */
export const CATEGORY_SPECIFIC_CHALLENGES: Record<IssueCategory, CategoryChallengeStrategy> = {
  security: {
    round2: `**安全问题专项确认：**
1. 攻击者的输入能否真正到达这段代码？
2. 是否存在上游的安全防护措施（sanitizer、validator、WAF）？
3. 框架或库是否已经内置了防护？`,
    round3: `**请提供安全防护措施的具体证据：**
1. 列出你检查过的安全中间件或验证函数
2. 追踪数据流：用户输入是如何到达这段代码的？
3. 如果存在防护，指出具体的代码位置`,
    round4Confirmed: `这个安全问题可能**不存在**的原因：
- 输入可能在上游已被过滤/转义
- 可能有全局安全中间件处理
- 框架可能有内置防护
- 代码可能只在受信任环境执行`,
    round4Rejected: `这个安全问题可能**确实存在**的原因：
- 可能遗漏了某些攻击向量
- 防护措施可能不完整
- 可能存在绕过方式
- 敏感操作可能缺少权限检查`,
  },
  logic: {
    round2: `**逻辑问题专项确认：**
1. 报告的边界条件在实际业务中是否可能发生？
2. 是否有测试用例覆盖这个场景？
3. 类型系统是否已经排除了这种情况？`,
    round3: `**请提供逻辑正确性的具体证据：**
1. 搜索相关的测试文件，看是否有覆盖
2. 检查调用链，上游是否保证了输入有效性
3. 检查是否有统一的错误处理机制`,
    round4Confirmed: `这个逻辑问题可能**不存在**的原因：
- 可能有测试覆盖这个场景
- 调用方可能保证了输入有效性
- 类型系统可能已排除问题情况
- 业务约束可能使边界条件不可达`,
    round4Rejected: `这个逻辑问题可能**确实存在**的原因：
- 测试可能没有覆盖边界情况
- 错误处理可能不完整
- 运行时类型可能与编译时不同
- 可能导致崩溃或错误结果`,
  },
  performance: {
    round2: `**性能问题专项确认：**
1. 你是否读取了被调用方法的实现？它的实际成本是多少？
2. 这段代码的调用频率是多少？
3. 频率 × 单次成本 = 总影响是否显著？`,
    round3: `**请提供性能影响的具体证据：**
1. 列出被调用方法的复杂度（O(1)? O(n)? 涉及I/O？）
2. 说明代码的调用场景和频率
3. 是否已存在缓存、memo、防抖等优化？`,
    round4Confirmed: `这个性能问题可能**不存在**的原因：
- 被调用方法可能是 O(1) 操作（如单例获取、Map.get）
- 代码可能不在热路径上
- 可能已有缓存/memo 机制
- 数据规模可能太小，优化无意义`,
    round4Rejected: `这个性能问题可能**确实存在**的原因：
- 被调用方法可能涉及 I/O 或重计算
- 循环中的调用可能累积成本
- 可能在渲染循环或事件处理中
- 数据量大时可能成为瓶颈`,
  },
  style: {
    round2: `**代码风格专项确认：**
1. 你是否搜索了项目中的类似代码？
2. 报告的"问题"风格在项目中是否广泛使用？
3. 是否有 ESLint/Prettier 规则明确禁止？`,
    round3: `**请提供项目风格标准的具体证据：**
1. 列出你搜索过的类似代码模式
2. 统计项目中使用该风格的数量
3. 引用相关的 ESLint 或 Prettier 配置`,
    round4Confirmed: `这个风格问题可能**不存在**的原因：
- 报告的风格可能是项目的主流模式
- 可能没有明确的风格规范禁止
- 建议的修改可能与项目风格不一致
- 可能只是个人偏好差异`,
    round4Rejected: `这个风格问题可能**确实存在**的原因：
- 可能明显违反项目 ESLint/Prettier 规则
- 命名可能与项目约定不一致
- 可能影响代码可读性
- 可能与同目录其他文件风格不同`,
  },
  maintainability: {
    round2: `**可维护性专项确认：**
1. 代码复杂度是否真的超出必要？
2. 项目中是否有类似的复杂模式？
3. 重构建议是否符合项目架构？`,
    round3: `**请提供可维护性问题的具体证据：**
1. 对比项目中类似功能的代码复杂度
2. 说明当前复杂度带来的具体问题
3. 验证重构建议是否与项目架构一致`,
    round4Confirmed: `这个可维护性问题可能**不存在**的原因：
- 复杂度可能与问题复杂度匹配
- 项目中可能广泛使用类似模式
- 简化可能引入其他问题
- 可能是必要的抽象`,
    round4Rejected: `这个可维护性问题可能**确实存在**的原因：
- 代码可能过度抽象
- 可能引入不必要的复杂度
- 可能难以理解和修改
- 可能增加技术债务`,
  },
};

/**
 * 获取指定类别的挑战策略
 */
export function getChallengeStrategy(category: IssueCategory): CategoryChallengeStrategy {
  return CATEGORY_SPECIFIC_CHALLENGES[category];
}
